!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.ParseEpub=e()}}(function(){return function e(t,r,n){function i(u,a){if(!r[u]){if(!t[u]){var c="function"==typeof require&&require;if(!a&&c)return c(u,!0);if(o)return o(u,!0);var f=new Error("Cannot find module '"+u+"'");throw f.code="MODULE_NOT_FOUND",f}var s=r[u]={exports:{}};t[u][0].call(s.exports,function(e){var r=t[u][1][e];return i(r?r:e)},s,s.exports,e,t,r,n)}return r[u].exports}for(var o="function"==typeof require&&require,u=0;u<n.length;u++)i(n[u]);return i}({1:[function(e,t,r){(function(t){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function i(e,t){for(var r=0,n=e.length-1;n>=0;n--){var i=e[n];"."===i?e.splice(n,1):".."===i?(e.splice(n,1),r++):r&&(e.splice(n,1),r--)}if(t)for(;r--;r)e.unshift("..");return e}function o(e,t){if(e.filter)return e.filter(t);for(var r=[],n=0;n<e.length;n++)t(e[n],n,e)&&r.push(e[n]);return r}function u(){for(var e="",r=!1,n=arguments.length-1;n>=-1&&!r;n--){var u=n>=0?arguments[n]:t.cwd();if("string"!=typeof u)throw new TypeError("Arguments to path.resolve must be strings");u&&(e=u+"/"+e,r="/"===u.charAt(0))}return e=i(o(e.split("/"),function(e){return!!e}),!r).join("/"),(r?"/":"")+e||"."}function a(e){var t=c(e),r="/"===$(e,-1);return e=i(o(e.split("/"),function(e){return!!e}),!t).join("/"),e||t||(e="."),e&&r&&(e+="/"),(t?"/":"")+e}function c(e){return"/"===e.charAt(0)}function f(){var e=Array.prototype.slice.call(arguments,0);return a(o(e,function(e,t){if("string"!=typeof e)throw new TypeError("Arguments to path.join must be strings");return e}).join("/"))}function s(e){var t=W(e),r=t[0],n=t[1];return r||n?(n&&(n=n.substr(0,n.length-1)),r+n):"."}function l(e){return W(e)[3]}function d(e,t,r,n){return Array.prototype.filter.call(e.querySelectorAll(t),function(e){return!n||n.indexOf(e.getAttribute(r.mediaType))>-1}).map(function(e){var t={};return Object.keys(r).forEach(function(n){try{t[n]=e.getAttribute(r[n])}catch(r){t[n]=void 0,console.error("Can't get "+n+" for "+e+" on "+tag+".")}}),t})}function p(e){var t={},r=e.map(function(e){return t[e.id]=e,e.id});return{byId:t,items:r}}function y(e,t){return p(d(e.querySelector(J),G,z,t))}function h(e){var t=e.byId["cover-item"]||e.byId.cover||e.byId[Object.keys(e.byId).find(function(t){return/cover-image/.test(e.byId[t].properties)})];if(t)return t.href}function m(e,t){function r(e,t){try{n[e]=i.getElementsByTagNameNS(Y,e)[0].textContent}catch(r){t&&(n[e]=void 0,console.error("Can't get required attribute '"+e+"' on metadata."))}}var n={},i=e.querySelector(ee);K.OPTIONAL.forEach(function(e){return r(e,!1)}),K.REQUIRED.forEach(function(e){return r(e,!0)}),n.coverHref=h(t);var o=i.querySelectorAll(Z+"[property='"+K.PROPERTIES.mediaDuration+"']");o.length&&(n.mediaOverlayDurations=[],n.mediaDuration,Array.prototype.forEach.call(o,function(e){var t=e.getAttribute("refines");t?n.mediaOverlayDurations.push({refines:e.getAttribute("refines"),clockValue:e.textContent}):n.mediaDuration=e.textContent}));var u=i.querySelector(Z+"[property='"+K.PROPERTIES.mediaActiveClass+"']");u&&(n.mediaActiveClass=u.textContent);var a=i.querySelectorAll(Z+"[property='"+K.PROPERTIES.mediaNarrator+"']");return a.length&&(n.mediaNarrator=Array.prototype.map.call(a,function(e){return e.textContent})),n}function v(e){var t=e.querySelector(te).getAttribute(re);if(".opf"===l(t))return t;throw new Error("no .opf file could be found in META-INF/container.xml")}function b(e,t){return p(d(e.querySelector(oe),ie,ne).filter(function(e){return"undefined"==typeof t||t.id!==e.id}).map(function(e){return{id:e.id,linear:e.linear===ue,properties:e.properties}}))}function g(e){var t=e.items.find(function(t){return/nav/.test(e.byId[t].properties)});return e.byId[t]}function E(e,t,r){function n(e,r,s,l,d){var p=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,y=s&&f(c,s.split("#")[0]),h=Object.keys(t.byId).find(function(e){return t.byId[e].href===y});if(a.id!==h){var m=e.querySelector("ol"),v=[];m&&(v=Array.prototype.filter.call(m.children,function(e){return"LI"===e.tagName}).map(function(e){var t=e.querySelector("a"),i=X();return n(e,i,t.getAttribute("href"),t.textContent,r,p+1)&&i}).filter(function(e){return e}));var b=0===v.length;return b&&(o[h]=r,u.push(r)),i[r]={childNodes:v,id:r,isLeaf:b,href:y,label:l,level:p,linear:e.getAttribute("linear"),manifestId:h,parentId:d},!0}return!1}var i={},o={},u=[],a=g(t),c=s(a.href);return n(e.querySelector(ae),ce),{byId:i,byManifestId:o,items:u}}function O(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:se;return le.parseFromString(e,t)}function I(e){return O(e,fe)}function T(e){return O(e,se)}function A(e){return fetch(e,{credentials:"include"}).then(function(e){return e.text()}).then(function(e){return T(e)})}function x(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:de;return A(e+"/"+t)}function w(e,t){return A(e+"/"+t)}function N(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pe,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ye;return fetch(e+"/"+r+"/"+t,{credentials:"include"}).then(function(e){return e.text()}).then(function(e){return I(e)})}function S(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=void 0;return x(e).then(function(e){return v(e)}).then(function(t){return r=s(t),w(e,t)}).then(function(n){var i=y(n,t),o=g(i),u=b(n,o);return N(e,o.href,r).then(function(e){return{packageDirectory:r,manifest:i,metadata:m(n,i),spine:u,toc:E(e,i,u)}})}).catch(function(t){var r=t;throw/Cannot read property 'getAttribute' of null/.test(t.message)&&(r=new Error("We couldn't find a book at "+e+".")),r})}function R(e,t,r){return A(e+"/"+r+"/"+t)}function q(e){return!(e.nodeType===window.Node.COMMENT_NODE||e.nodeType===window.Node.TEXT_NODE&&!/[^\t\n\r ]/.test(e.textContent))}function P(e){if(!e)return 0;var t=0,r=0,n=0,i={hours:e.indexOf(he),mins:e.indexOf(me),ms:e.indexOf(ve),secs:e.indexOf(be)};if(i.mins!==-1)r=parseFloat(e.substr(0,i.mins),10);else if(i.ms!==-1){var o=parseFloat(e.substr(0,i.ms),10);n=o/1e3}else if(i.secs!==-1)n=parseFloat(e.substr(0,i.secs),10);else if(i.hours!==-1)t=parseFloat(e.substr(0,i.hours),10);else{var u=e.split(ge);n=parseFloat(u.pop(),10),u.length>0&&(r=parseFloat(u.pop(),10),u.length>0&&(t=parseFloat(u.pop(),10)))}return 3600*t+60*r+n}function D(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments[3],i=e.querySelector(xe),o={body:j(i.querySelector(Ie),n),id:t,version:i.getAttribute(Ne)};return r.clockValue&&(o.duration=P(r.clockValue)),o}function k(e){return Array.prototype.filter.call(e.childNodes,q)}function C(e){function t(t,r,i){try{var o=e.getAttribute(r);if(!o)throw Exception("Attribute tag "+r+" exists but there's no value.");n[t]=o}catch(o){i&&(n[t]=!1,console.error("Can't get required attribute '"+r+"' for key '"+t+"' on smil.",e),console.error(o))}}var r=Se[e.nodeName],n={};return Object.keys(r.OPTIONAL).forEach(function(e){return t(e,r.OPTIONAL[e],!1)}),Object.keys(r.REQUIRED).forEach(function(e){return t(e,r.REQUIRED[e],!0)}),n}function L(e,t){return u(e,t)}function j(e,t){var r=void 0;switch(e.nodeName){case Oe:r=C(e),r.src&&!c(r.src)&&(r.src=L(t,r.src)),r.clipBegin=r.clipBegin&&P(r.clipBegin),r.clipEnd=r.clipEnd&&P(r.clipEnd);break;case Te:r=C(e);var n=e.querySelector(Oe);n&&(r.audio=j(n,t)),r.isPar=!0,r.text=j(e.querySelector(we),t);break;case Ie:case Ae:r=C(e),r.childNodes=k(e).map(function(e){return j(e,t)}),r.isPar=!1;break;case we:r=C(e),r.src&&!c(r.src)&&(r.src=L(t,r.src));var i=r.src.split("#"),o=Ee(i,2),u=o[0],a=o[1];r.srcFile=u,r.srcFragmentId=a}return r}function F(e){return e.items.filter(function(t){return e.byId[t].mediaOverlay})}function U(e,t,r,n){return Promise.all(t.map(function(t){var i=r.byId[t].mediaOverlay,o=r.byId[i].href;return R(e,o,n).then(function(e){return{manifestItemsXml:e,smilUri:o}})}))}function _(e,t,r,n){return function(n){var i={};return n.forEach(function(n,o){var u=e[o],a=t.byId[u].mediaOverlay,c=r.mediaOverlayDurations.find(function(e){return e.refines==="#"+a}),f=s(n.smilUri);i[a]=D(n.manifestItemsXml,a,c,f)}),{byId:i,items:e}}}function Q(e,t,r,n){var i=F(t);return U(e,i,t,n).then(function(n){return _(i,t,r,e)(n)}).catch(function(e){return console.error(e)})}function M(e,t,r,n){return Q(e,t,r,n)}function B(e,t,r,n){return A(e).then(function(n){return D(n,t,r,s(e))})}function V(e){return A(e).then(function(e){return D(e,"widget",{},"/")})}Object.defineProperty(r,"__esModule",{value:!0});var X=n(e("mini-unique-id")),H=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,W=function(e){return H.exec(e).slice(1)},$="b"==="ab".substr(-1)?function(e,t,r){return e.substr(t,r)}:function(e,t,r){return t<0&&(t=e.length+t),e.substr(t,r)},z={href:"href",id:"id",mediaType:"media-type",mediaOverlay:"media-overlay",properties:"properties"},G="item",J="manifest",K={OPTIONAL:["creator","contributor","coverage","creator","date","description","format","publisher","relation","rights","source","subject","type"],REQUIRED:["identifier","language","title"],PROPERTIES:{mediaActiveClass:"media:active-class",mediaDuration:"media:duration",mediaNarrator:"media:narrator"}},Y="*",Z="meta",ee="metadata",te="rootfile",re="full-path",ne={id:"idref",linear:"linear",properties:"properties"},ie="itemref",oe="spine",ue="yes",ae="nav[epub\\:type~=toc]",ce="__root__",fe="text/html",se="text/xml",le=new DOMParser,de="META-INF/container.xml",pe="toc.xhtml",ye="OPS",he="h",me="min",ve="ms",be="s",ge=":",Ee=function(){function e(e,t){var r=[],n=!0,i=!1,o=void 0;try{for(var u,a=e[Symbol.iterator]();!(n=(u=a.next()).done)&&(r.push(u.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw o}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),Oe="audio",Ie="body",Te="par",Ae="seq",xe="smil",we="text",Ne="version",Se={audio:{REQUIRED:{src:"src"},OPTIONAL:{id:"id",clipBegin:"clipBegin",clipEnd:"clipEnd"}},body:{REQUIRED:{},OPTIONAL:{id:"id",textref:"epub:textref",type:"epub:type"}},par:{REQUIRED:{},OPTIONAL:{id:"id",textref:"epub:textref",type:"epub:type"}},seq:{REQUIRED:{textref:"epub:textref"},OPTIONAL:{id:"id",type:"epub:type"}},text:{REQUIRED:{src:"src"},OPTIONAL:{id:"id"}}};r.parseBook=S,r.parseAllSmil=M,r.parseSingleSmil=B,r.parseSmil=V}).call(this,e("_process"))},{_process:3,"mini-unique-id":2}],2:[function(e,t,r){"use strict";function n(){return""+i++}var i=1;t.exports=n},{}],3:[function(e,t,r){function n(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function o(e){if(l===setTimeout)return setTimeout(e,0);if((l===n||!l)&&setTimeout)return l=setTimeout,setTimeout(e,0);try{return l(e,0)}catch(t){try{return l.call(null,e,0)}catch(t){return l.call(this,e,0)}}}function u(e){if(d===clearTimeout)return clearTimeout(e);if((d===i||!d)&&clearTimeout)return d=clearTimeout,clearTimeout(e);try{return d(e)}catch(t){try{return d.call(null,e)}catch(t){return d.call(this,e)}}}function a(){m&&y&&(m=!1,y.length?h=y.concat(h):v=-1,h.length&&c())}function c(){if(!m){var e=o(a);m=!0;for(var t=h.length;t;){for(y=h,h=[];++v<t;)y&&y[v].run();v=-1,t=h.length}y=null,m=!1,u(e)}}function f(e,t){this.fun=e,this.array=t}function s(){}var l,d,p=t.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:n}catch(e){l=n}try{d="function"==typeof clearTimeout?clearTimeout:i}catch(e){d=i}}();var y,h=[],m=!1,v=-1;p.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];h.push(new f(e,t)),1!==h.length||m||o(c)},f.prototype.run=function(){this.fun.apply(null,this.array)},p.title="browser",p.browser=!0,p.env={},p.argv=[],p.version="",p.versions={},p.on=s,p.addListener=s,p.once=s,p.off=s,p.removeListener=s,p.removeAllListeners=s,p.emit=s,p.binding=function(e){throw new Error("process.binding is not supported")},p.cwd=function(){return"/"},p.chdir=function(e){throw new Error("process.chdir is not supported")},p.umask=function(){return 0}},{}]},{},[1])(1)});
//# sourceMappingURL=dist/parse-epub.min.js.map
